<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transpetro - Previsão de Limpeza e Performance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; }
        .header { text-align: center; margin-bottom: 30px; color: #003366; }
        .nav-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 40px; }
        .nav-button {
            padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;
            background-color: #005f99; color: white; font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        .nav-button:hover { background-color: #007bb6; transform: translateY(-1px); }
        .dashboard {
            background-color: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .summary-box {
            display: flex; justify-content: space-around; flex-wrap: wrap;
            margin-bottom: 30px; text-align: center;
        }
        .summary-item {
            padding: 15px; border-radius: 8px; width: 250px; margin: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .status-0 { background-color: #e6ffe6; color: #008000; border-left: 5px solid #008000; }
        .status-1 { background-color: #ffffe0; color: #999900; border-left: 5px solid #999900; }
        .status-2 { background-color: #ffe8cc; color: #ff8c00; border-left: 5px solid #ff8c00; }
        .status-3 { background-color: #ffcccc; color: #cc0000; border-left: 5px solid #cc0000; }
        .status-4 { background-color: #f8e1e1; color: #8b0000; border-left: 5px solid #8b0000; }

        .chart-container { margin-top: 20px; width: 100%; max-width: 1000px; margin: 20px auto; }
        h3 { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 40px; color: #333; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header">
    <h1>Dashboard de Previsão de Casco (HPI)</h1>
    <p id="current-navio-name">Selecione um navio para iniciar a análise</p>
</div>

<div class="nav-list" id="ship-buttons">
    </div>

<div class="dashboard hidden" id="prediction-dashboard">

    <div class="summary-box">
        <div class="summary-item" id="summary-status">
            <strong>Status Atual do Casco:</strong><br><span id="status-descricao"></span>
        </div>
        <div class="summary-item status-0">
            <strong>Última Docagem:</strong><br><span id="ultima-limpeza"></span>
        </div>
        <div class="summary-item status-0">
            <strong>Data Sugerida de Limpeza:</strong><br><span id="data-ideal"></span>
        </div>
        <div class="summary-item status-0">
            <strong>Dias Pós-Limpeza:</strong><br><span id="dias-restantes"></span>
        </div>
        <div class="summary-item status-0">
            <strong>Combustível Extra Máximo:</strong><br><span id="max-fuel"></span> Ton/Dia
        </div>
    </div>

    <p style="text-align: center; font-style: italic;" id="justificativa-text"></p>

    <h3>HPI - Índice de Performance do Casco</h3>
    <div class="chart-container">
        <canvas id="hpiChart"></canvas>
    </div>

    <h3>Arrasto Relativo (%)</h3>
    <div class="chart-container">
        <canvas id="dragChart"></canvas>
    </div>

    <h3>Consumo Extra Diário (Ton/Dia) - Potencial de Economia</h3>
    <div class="chart-container">
        <canvas id="fuelChart"></canvas>
    </div>

</div>

<script>
    const NAVIOS = [
        "RAFAEL SANTOS", "HENRIQUE ALVES", "VICTOR OLIVEIRA", "FELIPE RIBEIRO",
        "GISELLE CARVALHO", "RAUL MARTINS", "PAULO MOURA", "MARCOS CAVALCANTI",
        "DANIEL PEREIRA", "CARLA SILVA", "RENATO GOMES", "GABRIELA MARTINS",
        "RODRIGO PINHEIRO", "EDUARDO COSTA", "THIAGO FERNANDES", "ROMARIO SILVA",
        "LUCAS MENDONÇA", "RICARDO BARBOSA", "BRUNO LIMA", "FÁBIO SANTOS", "MARIA VALENTINA"
    ];

    const API_URL = 'http://localhost:8080/api/v1/previsao/limpeza-sugerida?navioId=';

    let hpiChart, dragChart, fuelChart;

    // --- 1. FUNÇÕES DE INICIALIZAÇÃO ---

    document.addEventListener('DOMContentLoaded', () => {
        // Gera botões de navio
        const buttonContainer = document.getElementById('ship-buttons');
        NAVIOS.forEach(navio => {
            const button = document.createElement('button');
            button.className = 'nav-button';
            button.textContent = navio;
            button.onclick = () => fetchPrediction(navio);
            buttonContainer.appendChild(button);
        });
    });

    // --- 2. BUSCA DE DADOS NA API ---

    async function fetchPrediction(navioId) {
        document.getElementById('current-navio-name').textContent = `Carregando dados para: ${navioId}...`;

        try {
            const response = await fetch(API_URL + encodeURIComponent(navioId));
            if (!response.ok) {
                throw new Error(`Erro na API: ${response.statusText}`);
            }
            const data = await response.json();

            // Renderiza o dashboard com os dados recebidos
            renderDashboard(data);

        } catch (error) {
            console.error('Erro ao buscar a previsão:', error);
            alert('Erro ao carregar dados. Verifique se sua API está rodando em http://localhost:8080.');
            document.getElementById('current-navio-name').textContent = `Falha ao carregar dados para: ${navioId}`;
        }
    }

    // --- 3. PROCESSAMENTO E RENDERIZAÇÃO ---

    function renderDashboard(data) {
        document.getElementById('prediction-dashboard').classList.remove('hidden');
        document.getElementById('current-navio-name').textContent = `Análise de Previsão: ${data.navioId}`;

        // 3.1. Preparar Dados para Gráficos
        const labels = data.predictions.map(p => formatDate(p.data));
        const hpiData = data.predictions.map(p => p.hpi);
        const dragData = data.predictions.map(p => p.dragPercent);
        const fuelData = data.predictions.map(p => p.extraFuelTonPerDay);

        const suggestedDateIndex = data.predictions.findIndex(p => p.data === data.dataLimpezaIdeal);
        const suggestedDateLabel = suggestedDateIndex !== -1 ? labels[suggestedDateIndex] : null;

        const maxHpi = Math.max(...hpiData);

        // 3.2. Renderizar Sumário
        updateSummary(data);

        // 3.3. Renderizar Gráficos

        // Destrói gráficos antigos para evitar sobreposição
        if (hpiChart) hpiChart.destroy();
        if (dragChart) dragChart.destroy();
        if (fuelChart) fuelChart.destroy();

        // Obtém o limite dinâmico (necessário para o gráfico de HPI)
        let dynamicHpiLimit = 0;
        if (suggestedDateIndex !== -1 && data.dataLimpezaIdeal) {
             // Se houver data sugerida, o HPI nesse dia é o limite que disparou o gatilho
             dynamicHpiLimit = hpiData[suggestedDateIndex];
        } else if (maxHpi > 1.0) {
            // Se não houver data, podemos estimar o limite pelo HPI final da projeção
            dynamicHpiLimit = hpiData[hpiData.length - 1];
        }

        hpiChart = createHPIChart('hpiChart', labels, hpiData, dynamicHpiLimit);
        dragChart = createLineChart('dragChart', labels, dragData, 'Arrasto (%)', 'rgba(255, 99, 132, 1)');
        fuelChart = createLineChart('fuelChart', labels, fuelData, 'Consumo Extra (Ton/Dia)', 'rgba(54, 162, 235, 1)');
    }

    // --- 4. FUNÇÕES AUXILIARES ---

    function updateSummary(data) {
        document.getElementById('ultima-limpeza').textContent = formatDate(data.dataUltimaLimpeza);
        document.getElementById('data-ideal').textContent = data.dataIdealLimpeza ? formatDate(data.dataIdealLimpeza) : 'Não necessário em 180 dias';
        document.getElementById('dias-restantes').textContent = data.diasParaIntervencao > 0 ? data.diasParaIntervencao + ' dias' : 'N/A';
        document.getElementById('max-fuel').textContent = data.maxExtraFuelTonPerDay.toFixed(2);
        document.getElementById('justificativa-text').textContent = data.justificativa;

        // Atualiza Status e Estilo
        const statusElement = document.getElementById('summary-status');
        const statusDesc = document.getElementById('status-descricao');

        // Remove classes de status antigas
        statusElement.className = 'summary-item';
        // Adiciona a nova classe de status
        statusElement.classList.add(`status-${data.nivelBioincrustacao}`);
        statusDesc.textContent = data.statusCascoAtual;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    function createLineChart(canvasId, labels, data, label, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Data' },
                        ticks: {
                             // Mostra apenas 1 tick a cada 30 (mensal) para não poluir
                            autoSkip: true,
                            maxTicksLimit: 6
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: label }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function createHPIChart(canvasId, labels, hpiData, limit) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        // Linha do Limite Dinâmico
        const limitLineData = new Array(hpiData.length).fill(limit);

        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'HPI Projetado',
                        data: hpiData,
                        borderColor: 'rgba(0, 95, 153, 1)',
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: `Limite Dinâmico (${limit.toFixed(3)})`,
                        data: limitLineData,
                        borderColor: 'rgba(255, 0, 0, 0.7)',
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Data' },
                        ticks: { autoSkip: true, maxTicksLimit: 6 }
                    },
                    y: {
                        beginAtZero: false,
                        min: 1.00,
                        max: Math.max(1.10, Math.ceil(Math.max(...hpiData) * 10) / 10), // Garante que 1.10 seja visível
                        title: { display: true, text: 'HPI (Hull Performance Index)' }
                    }
                }
            }
        });
    }

</script>
</body>
</html>